- name: SSH and deploy (with failure trace)
  run: |
    ssh -tt \
      -o StrictHostKeyChecking=no \
      -o ServerAliveInterval=30 -o ServerAliveCountMax=10 \
      -i key.pem ubuntu@${{ secrets.EC2_PUBLIC_IP }} << 'EOF'
    set -Eeuo pipefail
    PS4='+ [\D{%H:%M:%S}] ${BASH_SOURCE##*/}:${LINENO}: '
    trap 'rc=$?; echo ""; echo "❌ FAILED at: ${BASH_SOURCE##*/}:${LINENO} -> \`${BASH_COMMAND}\` (exit $rc)"; exit $rc' ERR
    set -x

    # Safer repo sync (avoids interactive merge failures)
    cd ~/MoodyClues-Journaling-App 2>/dev/null || cd ~/ModyClues-Journaling-App
    git fetch origin main --depth=1
    git reset --hard origin/main

    cd backend-spring/MoodyClues
    chmod +x mvnw

    ./mvnw -v
    echo "🔁 Flyway..."
    ./mvnw -B -Dorg.slf4j.simpleLogger.log.org.flywaydb=debug flyway:migrate \
      -Dflyway.user=${{ secrets.RDS_USERNAME }} \
      -Dflyway.password=${{ secrets.RDS_PASSWORD }} \
      -Dflyway.url=jdbc:mysql://moodyclues-db-1.c52ysku4cuy5.ap-southeast-1.rds.amazonaws.com:3306/moodyclues_db?allowPublicKeyRetrieval=true&useSSL=false&serverTimezone=Asia/Singapore

    echo "🧱 Build JAR..."
    ./mvnw -B -DskipTests clean package

    echo "🛑 Stop old container..."
    docker stop moodyclues-container || true
    docker rm moodyclues-container || true

    echo "🐳 Build image..."
    docker build -t moodyclues-backend .

    echo "🚀 Run..."
    docker run -d --name moodyclues-container -p 8080:8080 moodyclues-backend

    echo "✅ Done."
    EOF
