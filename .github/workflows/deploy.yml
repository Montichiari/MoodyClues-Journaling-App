name: Deploy to EC2
on:
  push:
    branches: [ "main" ]

jobs:
  deploy:
    name: Deploy Backend to EC2
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Recreate PEM key
        run: |
          echo "${{ secrets.EC2_SSH_KEY }}" | base64 -d > key.pem
          chmod 600 key.pem

      - name: SSH and deploy (keepalive + heartbeat)
        run: |
          ssh \
            -o StrictHostKeyChecking=no \
            -o ServerAliveInterval=30 \
            -o ServerAliveCountMax=10 \
            -o TCPKeepAlive=yes \
            -o ConnectTimeout=30 \
            -i key.pem ubuntu@${{ secrets.EC2_PUBLIC_IP }} << 'EOF'
          set -euo pipefail

          # --- keep log output flowing to avoid idle disconnects ---
          ( while true; do echo "[deploy][heartbeat] $(date -u +"%Y-%m-%dT%H:%M:%SZ")"; sleep 25; done ) &
          HB=$!
          trap 'kill $HB || true' EXIT
          # ---------------------------------------------------------

          cd ~/ModyClues-Journaling-App || cd ~/MoodyClues-Journaling-App
          git pull origin main

          cd backend-spring/MoodyClues
          chmod +x mvnw
          
          echo "ðŸ” Running Flyway migrations (verbose)..."
          ./mvnw flyway:migrate \
            -Dflyway.user=admin \
            -Dflyway.password=flashthunder \
            -Dflyway.url=jdbc:mysql://moodyclues-db-1.c52ysku4cuy5.ap-southeast-1.rds.amazonaws.com:3306/moodyclues_db?allowPublicKeyRetrieval=true&useSSL=false&serverTimezone=Asia/Singapore \
            -Dorg.slf4j.simpleLogger.log.org.flywaydb=debug

          echo "âœ… Flyway migration done, building app..."
          ./mvnw clean install

          echo "ðŸ§¼ Stopping and removing existing container..."
          docker stop moodyclues-container || true
          docker rm moodyclues-container || true

          echo "ðŸ³ Building Docker image..."
          docker build -t moodyclues-backend .

          echo "ðŸš€ Starting container (detached)..."
          docker run -d \
            --name moodyclues-container \
            -p 8080:8080 \
            moodyclues-backend

          echo "âœ… Deployment complete."
          EOF
