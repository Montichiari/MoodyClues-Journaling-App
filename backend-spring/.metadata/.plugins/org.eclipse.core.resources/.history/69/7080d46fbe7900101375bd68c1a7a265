package com.moodyclues.serviceimpl;

import java.util.List;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.http.HttpStatus;
import org.springframework.stereotype.Service;
import org.springframework.web.server.ResponseStatusException;

import com.moodyclues.model.CounsellorUser;
import com.moodyclues.model.JournalUser;
import com.moodyclues.model.LinkRequest;
import com.moodyclues.model.LinkRequest.Status;
import com.moodyclues.repository.CounsellorRepository;
import com.moodyclues.repository.JournalUserRepository;
import com.moodyclues.repository.LinkRequestRepository;
import com.moodyclues.service.LinkRequestService;

import jakarta.persistence.EntityNotFoundException;
import jakarta.transaction.Transactional;

@Service
@Transactional
public class LinkRequestServiceImpl implements LinkRequestService {

	@Autowired
	LinkRequestRepository linkRepo;
	
	@Autowired
	JournalUserRepository juserRepo;
	
	@Autowired
	CounsellorRepository cRepo;
	

	@Override
	public LinkRequest createNewRequest(String counsellorId, String userEmail) {
        CounsellorUser counsellor = cRepo.findById(counsellorId)
                .orElseThrow(() -> new EntityNotFoundException("Counsellor not found"));

            JournalUser journalUser = juserRepo.findJournalUserByEmail(userEmail)
                .orElseThrow(() -> new EntityNotFoundException("Journal user not found"));


            if (counsellor.getClients().contains(journalUser)) {
                throw new ResponseStatusException(HttpStatus.CONFLICT, "Already linked");
            }
            
            if (linkRepo.existsPending (
                    counsellorId, journalUser.getId(), Status.PENDING)) {
                throw new ResponseStatusException(HttpStatus.CONFLICT, "Pending request exists");
            }

            LinkRequest linkRequest = new LinkRequest();
            linkRequest.setCounsellorUser(counsellor);
            linkRequest.setJournalUser(journalUser);
            linkRequest.setStatus(Status.PENDING);
            return linkRepo.save(linkRequest);
	}

	@Override
	public void requestDecision(String userId, String requestId, boolean approved) {
        
		LinkRequest linkRequest = linkRepo.findByIdAndJournalUserId(requestId, userId)
                .orElseThrow(() -> new ResponseStatusException(HttpStatus.NOT_FOUND, "Request not found"));

            if (linkRequest.getStatus() != Status.PENDING) {
                throw new ResponseStatusException(HttpStatus.CONFLICT, "Already decided");
            }

            if (approved) {
            	linkRequest.setStatus(Status.ACCEPTED);
                CounsellorUser c = linkRequest.getCounsellorUser();
                JournalUser j = linkRequest.getJournalUser();
                c.getClients().add(j);
                j.getCounsellors().add(c);
            } else {
            	linkRequest.setStatus(Status.DECLINED);
            }	
		
	}
	
	@Override
	public List<LinkRequest> getAllLinkRequestsByCounsellorId(String id) {

		List<LinkRequest> requests = linkRepo.findAllByCounsellorId(id);
		
		return requests;
	}

	@Override
	public List<LinkRequest> getAllLinkRequestsByJournalUserId(String id) {
		
		List<LinkRequest> requests = linkRepo.findAllByJournalUserId(id);
		
		return requests;
	}
	
		
	
    @Override
    @Transactional
    public List<LinkRequest> listIncoming(String journalUserId) {
        return linkRepo.findIncoming(
            journalUserId, Status.PENDING);
    }

    @Override
    @Transactional
    public List<LinkRequest> listOutgoing(String counsellorId) {
        return linkRepo.findOutgoing(
            counsellorId, Status.PENDING);
    }

	@Override
	public List<LinkRequest> getAllLinkRequestsByCounsellorIdAccepted(String id) {
		
		List<LinkRequest> requests = linkRepo.findApprovedClients(id, LinkRequest.Status Accepted);
		
		return requests;
	}


}
